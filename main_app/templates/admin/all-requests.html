{% load static %}
{% include 'common/head.html' %}
{% include 'common/nav.html' %}

<!-- Sidebar -->
<aside id="logo-sidebar"
  class="fixed top-0 left-0 z-40 w-64 h-screen pt-20 transition-transform -translate-x-full bg-white border-r border-gray-200 sm:translate-x-0 dark:bg-gray-800 dark:border-gray-700"
  aria-label="Sidebar">
  <div class="h-full px-3 pb-4 overflow-y-auto bg-white dark:bg-gray-800">
    <ul class="space-y-2 font-medium">
      <li>
        <a href="/admin/dashboard/" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
          <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
            fill="currentColor" viewBox="0 0 22 21">
            <path d="M16.975 11H10V4.025a1 1 0 0 0-1.066-.998A8.5 8.5 0 1 0 18 12a1 1 0 0 0-1.025-1Z" />
          </svg>
          <span class="ms-3">Dashboard</span>
        </a>
      </li>

      <li>
        <a href="/admin/all-requests/" class="flex items-center p-2 text-gray-900 rounded-lg bg-gray-100 dark:text-white dark:hover:bg-gray-700 group">
          <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
            fill="currentColor" viewBox="0 0 18 18">
            <path d="M6.143 0H1.857A1.857 1.857 0 0 0 0 1.857v4.286A1.857 1.857 0 0 0 1.857 8h4.286A1.857 1.857 0 0 0 8 6.143V1.857A1.857 1.857 0 0 0 6.143 0ZM16.143 0H11.857A1.857 1.857 0 0 0 10 1.857v4.286A1.857 1.857 0 0 0 11.857 8h4.286A1.857 1.857 0 0 0 18 6.143V1.857A1.857 1.857 0 0 0 16.143 0Z" />
          </svg>
          <span class="flex-1 ms-3 whitespace-nowrap">All Requests</span>
        </a>
      </li>

      <li>
        <a href="/admin/create-driver/" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
          <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
            fill="currentColor" viewBox="0 0 20 20">
            <path d="m17.418 3.623-.018-.008A6.713 6.713 0 0 0 15 3V2h1a1 1 0 0 0 0-2h-2a1 1 0 0 0-1 1v2H9.89A6.977 6.977 0 0 1 12 8v5h-2V8A5 5 0 1 0 0 8v6a1 1 0 0 0 1 1h8v4a1 1 0 0 0 1 1h2v-4h6a1 1 0 0 0 1-1V8a5 5 0 0 0-2.582-4.377ZM6 12H4a1 1 0 0 1 0-2h2a1 1 0 0 1 0 2Z" />
          </svg>
          <span class="flex-1 ms-3 whitespace-nowrap">Create Driver</span>
        </a>
      </li>

      <li>
        <a href="/admin/all-drivers/" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
          <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
            fill="currentColor" viewBox="0 0 18 20">
            <path d="M17 5.923A1 1 0 0 0 16 5h-3V4a4 4 0 1 0-8 0v1H2a1 1 0 0 0-1 .923L.086 17.846A2 2 0 0 0 2.08 20h13.84a2 2 0 0 0 1.994-2.153L17 5.923ZM7 9a1 1 0 0 1-2 0V7h2v2Zm6 0a1 1 0 1 1-2 0V7h2v2Z" />
          </svg>
          <span class="flex-1 ms-3 whitespace-nowrap">All Drivers</span>
        </a>
      </li>

      <li>
        <a href="/admin/logout/" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
          <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
            fill="none" viewBox="0 0 18 16">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M1 8h11m0 0L8 4m4 4-4 4m4-11h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-3" />
          </svg>
          <span class="flex-1 ms-3 whitespace-nowrap">Logout</span>
        </a>
      </li>
    </ul>
  </div>
</aside>

<!-- Main Content -->
<div class="p-4 sm:ml-64">
  <div class="container max-w-7xl mx-auto p-6 mt-14 bg-white rounded-2xl shadow">
    <h2 class="text-2xl font-bold mb-6 text-indigo-600">Previous Requests</h2>

    <!-- Filter Controls -->
    <div class="flex flex-wrap gap-6 mb-6">
      <div>
        <label for="filter" class="mr-2 font-semibold">Filter by Status:</label>
        <select id="filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-blue-200">
          <option value="all">All</option>
          <option value="pending" selected>Pending</option>
          <option value="rejected">Rejected</option>
          <option value="resolved">Resolved</option>
        </select>
      </div>

      <div>
        <label for="driverFilter" class="mr-2 font-semibold">Filter by Driver:</label>
        <select id="driverFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-blue-200">
          <option value="all">All</option>
          {% for driver in drivers %}
            <option value="{{ driver.name }}">{{ driver.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Requests Table -->
    <div class="overflow-x-auto">
      <table class="w-full table-auto border border-gray-200 rounded-lg">
        <thead class="bg-gray-100 text-gray-800">
          <tr>
            <th class="px-4 py-2">Name</th>
            <th class="px-4 py-2">Email</th>
            <th class="px-4 py-2">Address</th>
            <th class="px-4 py-2">Request Type</th>
            <th class="px-4 py-2">Time</th>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Assigned Driver</th>
            <th class="px-4 py-2">Assign Driver</th>
            <th class="px-4 py-2">Unassign Driver</th>
            <th class="px-4 py-2">Reject</th>
            <th class="px-4 py-2">Message</th>
          </tr>
        </thead>
        <tbody>
          {% for item in requests %}
            <tr class="border-b hover:bg-gray-50">
              <td class="px-4 py-2">{{ item.name }}</td>
              <td class="px-4 py-2">{{ item.email }}</td>
              <td class="px-4 py-2">{{ item.address }}</td>
              <td class="px-4 py-2">{{ item.request_type }}</td>
              <td class="px-4 py-2 text-sm">{{ item.time }}</td>
              <td id="status" class="px-4 py-2">{{ item.status }}</td>
              <td id="assignedDriver" class="px-4 py-2">{{ item.assigned_driver|default:"None" }}</td>

              <td class="px-4 py-2">
                <form action="{% url 'admin_assign_driver' %}" method="post">
                  {% csrf_token %}
                  <input type="hidden" name="request_id" value="{{ item.id }}">
                  <select name="driver_id" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">Select Driver</option>
                    {% for driver in drivers %}
                      <option value="{{ driver.id }}">{{ driver.name }}</option>
                    {% endfor %}
                  </select>
                  <button type="button"
        onclick="submitAssignForm('{{ item.id }}')"
        class="mt-2 w-full bg-green-500 hover:bg-green-700 text-white text-sm py-1 rounded">
  Assign
</button>
<script>
function submitAssignForm(requestId) {
    const form = document.querySelector(`form[action="/admin/assign-driver/"] input[value="${requestId}"]`).closest("form");
    const formData = new FormData(form);

    fetch("/admin/assign-driver/", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.isOK) {
            showSuccess("Driver assigned successfully!");
        } else {
            alert(data.msg || "Something went wrong");
        }
    })
    .catch(err => {
        alert("Network error");
    });
}
</script>

                </form>
              </td>

              <td class="px-4 py-2">
  <button
    onclick="unassignDriver('{{ item.id }}', this)"
    class="bg-red-500 hover:bg-red-700 text-sm text-white font-bold py-2 px-4 rounded">
    Unassign
  </button>
</td>

<td class="px-4 py-2">
  <button
    onclick="rejectRequest('{{ item.id }}', this)"
    class="bg-orange-500 hover:bg-orange-700 text-sm text-white font-bold py-2 px-4 rounded">
    Reject
  </button>
</td>

              <td class="px-4 py-2 truncate">
                {% if item.message|length > 20 %}
                  {{ item.message|slice:":20" }}...
                  <button class="text-blue-500 hover:text-blue-700" onclick="showFullMessage('{{ item.message }}')">Show more</button>
                {% else %}
                  {{ item.message }}
                {% endif %}
              </td>
              
            </tr>
          {% empty %}
            <tr><td colspan="11" class="text-center py-4 text-gray-500">No requests found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="fixed z-10 inset-0 hidden bg-gray-800 bg-opacity-70 flex items-center justify-center">
  <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-lg">
    <h3 class="text-lg font-bold text-gray-900 mb-4">Message</h3>
    <p class="text-gray-700 mb-4" id="modal-message"></p>
    <button onclick="closeModal()" class="bg-indigo-500 hover:bg-indigo-700 text-white px-4 py-2 rounded">Close</button>
  </div>
</div>

{% include 'common/footer.html' %}

<script>
  function showFullMessage(message) {
    const modal = document.getElementById('modal');
    document.getElementById('modal-message').textContent = message;
    modal.classList.remove('hidden');
  }

  function closeModal() {
    document.getElementById('modal').classList.add('hidden');
  }

  // helper to get CSRF token from cookie (if you enable CSRF on view later)
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }

  async function assignDriver(requestId) {
    const select = document.getElementById('driver-select-' + requestId);
    if (!select) {
      alert('Driver select not found for request ' + requestId);
      return;
    }
    const driverId = select.value;
    if (!driverId) {
      alert('Please select a driver first.');
      return;
    }

    try {
      const res = await fetch('/admin/assign-driver/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // 'X-CSRFToken': getCookie('csrftoken')  // uncomment if view is not csrf_exempt
        },
        body: JSON.stringify({ driverId: driverId, requestId: requestId })
      });

      const data = await res.json();

      if (data.isOK) {
        // show success & update UI
        alert('Assigned: ' + (data.driverName || driverId));
        // Optionally update the "Assigned Driver" cell in this row
        const assignedCell = document.getElementById('assigned-driver-' + requestId);
        if (assignedCell) {
          assignedCell.textContent = data.driverName || driverId;
        }
      } else {
        alert('Failed: ' + (data.msg || 'Unknown error'));
      }
    } catch (err) {
      console.error(err);
      alert('Network or server error. See console.');
    }
  }

  async function unassignDriver(requestId) {
    // Similar pattern for unassign: call /admin/unassign-driver/?requestId=...
    try {
      const res = await fetch(`/admin/unassign-driver/?requestId=${encodeURIComponent(requestId)}`);
      const data = await res.json();
      if (data.isOK) {
        alert(data.msg || 'Unassigned');
        const assignedCell = document.getElementById('assigned-driver-' + requestId);
        if (assignedCell) assignedCell.textContent = 'None';
      } else {
        alert('Failed: ' + (data.msg || 'Unknown'));
      }
    } catch (e) {
      console.error(e);
      alert('Network error (unassign).');
    }
  }
</script>
<!-- SUCCESS POPUP -->
<div id="successModal"
     class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden">
  <div class="bg-white p-8 rounded-xl shadow-lg w-[400px] text-center">

    <div class="flex justify-center mb-4">
      <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
        <svg width="40" height="40" fill="none" stroke="#22c55e" stroke-width="3"
             stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 29l-7-7 2.5-2.5L20 24l9.5-9.5L32 17l-12 12z"/>
        </svg>
      </div>
    </div>

    <h2 class="text-xl font-semibold text-gray-800 mb-2">Success!</h2>
    <p id="successMessage" class="text-gray-600 mb-6"></p>

    <button onclick="closeSuccessModal()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg">
      OK
    </button>
  </div>
</div>

<script>
  function showSuccess(message) {
    document.getElementById('successMessage').innerText = message;
    document.getElementById('successModal').classList.remove('hidden');
  }

  function closeSuccessModal() {
    document.getElementById('successModal').classList.add('hidden');
    location.reload(); 
  }
</script>
<script>
  // helper to read CSRF token from cookies
  function getCookie(name) {
    const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return match ? match.pop() : '';
  }

  async function unassignDriver(requestId, btnElem) {
    if (!confirm('Unassign driver from this request?')) return;

    // disable button while working
    if (btnElem) { btnElem.disabled = true; btnElem.classList.add('opacity-60', 'cursor-not-allowed'); }

    try {
      const res = await fetch(`/admin/unassign-driver/?requestId=${encodeURIComponent(requestId)}`, {
        method: 'GET', // your view accepts GET params (fine) â€” you can change to POST if you prefer
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')  // harmless for GET, required if you later switch to POST
        }
      });

      const data = await res.json();

      if (data && data.isOK) {
        // show same success modal
        showSuccess(data.msg || 'Driver unassigned successfully.');

        // update UI in the row: status and assigned driver cells (if present)
        try {
          const assignedCell = document.querySelector(`[data-assigned-driver="${requestId}"]`);
          if (assignedCell) assignedCell.textContent = 'None';

          const statusCell = document.querySelector(`[data-status="${requestId}"]`);
          if (statusCell) statusCell.textContent = 'pending';
        } catch (e) { /* ignore if not found */ }

      } else {
        alert(data.msg || 'Failed to unassign driver.');
        if (btnElem) { btnElem.disabled = false; btnElem.classList.remove('opacity-60','cursor-not-allowed'); }
      }
    } catch (err) {
      console.error(err);
      alert('Network error while unassigning driver.');
      if (btnElem) { btnElem.disabled = false; btnElem.classList.remove('opacity-60','cursor-not-allowed'); }
    }
  }

  async function rejectRequest(requestId, btnElem) {
    if (!confirm('Are you sure you want to reject this request?')) return;

    if (btnElem) { btnElem.disabled = true; btnElem.classList.add('opacity-60','cursor-not-allowed'); }

    try {
      // Reject endpoint uses GET request param in your view; we call it and expect JSON response
      const res = await fetch(`/admin/reject-request/?requestId=${encodeURIComponent(requestId)}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });

      const data = await res.json();

      if (data && data.isOK) {
        showSuccess(data.msg || 'Request rejected successfully.');

        // Update UI in row: status cell
        try {
          const statusCell = document.querySelector(`[data-status="${requestId}"]`);
          if (statusCell) statusCell.textContent = 'rejected';
        } catch (e) { /* ignore */ }

      } else {
        alert(data.msg || 'Failed to reject request.');
        if (btnElem) { btnElem.disabled = false; btnElem.classList.remove('opacity-60','cursor-not-allowed'); }
      }
    } catch (err) {
      console.error(err);
      alert('Network error while rejecting request.');
      if (btnElem) { btnElem.disabled = false; btnElem.classList.remove('opacity-60','cursor-not-allowed'); }
    }
  }
</script>



</body>
</html>
